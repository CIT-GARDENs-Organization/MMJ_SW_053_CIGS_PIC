# フラッシュメモリの概要
Gardensにて使用しているフラッシュメモリは「MT25QL01GBBB」および「MT25QL128ABA」である。二つの主な違いは記録容量とそれに付随するアドレス指定のデータ長であるため、本文書では記録容量の大きい「MT25QL01GBBB」をメインに解説する。
今回使用する「MT25QL01GBBB」はNORフラッシュである。以下に特徴を示す(by GPT)。

- **ランダムアクセス性能**  
「MT25QL01GBBB」は、各メモリアドレスに直接アクセスできるため、CPUがプログラムを直接実行することが可能です。  

- **高速な読み出し**  
  読み出し速度が速く、プログラムの実行に適しています。  
  - 主にプログラムのコード格納やファームウェアの保存に利用される。

## NORフラッシュのアドレス構造
「MT25QL01GBBB」は、各アドレスあたり1Byteのデータを格納できる。
一方で書き込みと消去に関しては以下の特徴がある(by GPT)。
- **書き込み・消去の特性**  
  - **書き込み単位**：  
    「MT25QL01GBBB」は、バイトま単位での書き込みが可能です。細かいデータ更新ができるため、プログラムの修正やパラメータの更新に適しています。 

  - **消去単位**：  
    消去は、通常セクタまたはサブセクタ単位で行われます。消去対象の範囲は、4kByte(subsector) 32kByte(subsector) or 64kByte(sector)となり書き込み単位よりも大きな単位となります。

次の図はアドレスとセクタ・サブセクタの分類を示している。
![alt text](MemoryMap.png)
イメージはマンションである。
各々の部屋番号がアドレス、部屋の中身をデータとする。1階あたり4096部屋存在し、これが4kByteサブセクタである。 
書き込みは1部屋あたりで行い、データの消去は1階あたりを最小単位として実施する必要がある。
また、隣の部屋へのデータ移動といった処理はないため、複数Byteの書き込みはアドレスをインクリメントする必要がある。

## 書き込みと消去の操作

### 書き込み操作

- **単位**  
  - 書き込みは、バイト単位で実施可能なため、必要な部分だけを更新することができます。
- **制約**  
  - 一度「0」に書き込んだビットを再度「1」にすることはできず、データの更新の際には、消去操作が必要となります。

### 消去操作

- **消去単位**  
  - 消去は、通常セクタまたはブロック単位で行われ、これにより一括してメモリセルの内容が「1」にリセットされます。
- **影響**  
  - 消去は、書き込みよりも時間がかかるため、頻繁な更新が必要な用途では、設計上の注意が必要です。  
  - 消去操作が原因で、全体の動作速度や耐久性に影響を与える可能性があるため、適切な管理（例：ガーベジコレクションやウェアレベリング）が求められます。

### アドレスの指定方法
アドレスは二つの指定方法があり、コマンドが異なる。

**3バイトアドレスモード**:
- 24ビットアドレスにより、最大16MB（128Mb）までアクセス可能
- 1Gb（128MB）アクセスには通常は4バイトモードが必要となる場合もあるが、MT25QL01GBBBは3バイト／4バイトの両モードに対応

**4バイトアドレスモード**:
- アドレス拡張により、128Mbを超えるメモリアクセスが可能
- 4バイトモードを使用する場合、コマンドおよび設定によりアドレスサイズが切り替わる

## コマンドセットと各種操作

MT25QL01GBBBでは、多彩なコマンドにより以下の操作が行えます。以下に主要なコマンドおよび手順の概要を示します。
### **書き込み前の準備**

- Write Enable (0x06)
プログラム／消去を行う前に必ず発行する必要があります。

書き込み有効状態（Write Enable Latch）がセットされます。

- Write Disable (0x04):デフォルト状態なので不要
書き込み保護を解除するために使用します。

### **読み出し操作**

- 標準読み出し (0x03、0x13)

3バイトまたは4バイトのアドレスを入力し、シリアルにデータを読み出します。
    
### **プログラム（書き込み）操作**

- ページプログラム (0x02、0x12)

ページ単位（通常256バイト）のプログラムが可能。

書き込みは「1→0」の変化のみ可能であり、既存の1ビットを0に変更します。

書き込み後は自動的にWrite Enableが解除されるので、次回以降も再度有効化が必要です。

    
### **消去操作**

- サブセクター消去
4KBまたは32KB単位の消去が可能。

    4KBサブセクター消去
    0x20、0x21

    32KBサブセクター消去
    0x52、0x5C


- セクター消去
    
    64KB単位の消去が行えます。
    0xD8、0xDC
    
### **ステータスレジスタとフラグ**

- ステータスレジスタ (0x05)
Write Enable Latch、Busy状態などの情報を確認可能。

書き込み・消去の実行中(Busy)を判定するために使用する。

※ コマンド送信時には、各種クロック、ダミーサイクル、アドレスモードなどの設定が重要となるため、データシート内のタイミング図・設定値を参照してください。


## 実際の操作例
### セクター消去手順例

- Write Enable コマンド (0x06) を発行

消去開始前に書き込み有効状態にする。
- ステータスレジスタ/フラグレジスタの確認

消去開始前に、Busy状態がクリアであることを確認。
- セクター消去コマンド (例: 0xD8)

3バイトまたは4バイトのアドレスを指定して、64KBセクターを消去。
    
- 消去完了待ち

ステータスレジスタのBusyビットがクリアされるまでポーリング。

### ページプログラム（書き込み）手順例
- Write Enable (0x06) を発行
- プログラムコマンド (例: 0x02) とアドレス・データを送信

ページ内の指定アドレスに対して、最大256バイトのデータを送信
- プログラム完了待ち

- ステータス/フラグレジスタをポーリングして、Busy状態が解除されるのを確認

## 注意点・運用上のポイント
**アドレスモードの選択**

「MT25QL01GBBB」の場合、メモリマップや消去領域に応じて3バイトまたは4バイトアドレスモードを適切に選択する必要があります。

「MT25QL128ABA」の場合、3バイトアドレスモードを適切に選択する必要があります。


# ライブラリの解説
ライブラリ()の使用方法
以下の4つの手順が必要になる。
1. DEBUGポートの指定  
  .hファイル9行目に記載された部分を変更する。
  動作の完了などをプリントするポート名を記入する。
```cpp:GDNS_226_FlashOperation.h
#ifdef DEBUG
   #define DEBUG_PORT pc
#endif
```
1. SPIストリームの指定  
  .hファイル16行目に記載された部分を変更する。
  1つのSPIストリーム当たり1つのSPIストリーム名を記入する。使わないポートでも仮で実際に定義するSPIポートを宣言しておくこと。
```cpp:GDNS_226_FlashOperation.h
#define FLASH_STREAM0 spi1(ここを変更)
#define FLASH_STREAM1 spi2(ここを変更)
#define FLASH_STREAM2 spi3(ここを変更)
#define FLASH_STREAM3 spi4(ここを変更)
typedef enum spi_stream{
   SPI_0,
   SPI_1,
   SPI_2,
   SPI_3,
}SpiStreamId;
```
FLASH_STREAMxとSPI_xは対応させて使用します。
SPI_xは次々の手順でSPIストリームIDとして使用します。

1. ライブラリのインクルード  
  SPIの宣言をしているmain.hなどをインクルード後に.h→.cファイルの順にインクルードする。

1. 使用フラッシュ毎に構造体のメンバの宣言  
  ライブラリのインクルード後にFlash構造体のメンバを宣言する。
```cpp:main.c
#include <GDNS_226_FlashOperation.h>
#include <GDNS_226_FlashOperation.c>
Flash SMF = {SPIストリームID(SPI_0~SPI_3),使用するフラッシュの型番(MT25QL01GBBB or MT25QL128ABA),使用するSPIのCSピン(例：PIN_A2)};
```
各関数を実行する際は、構造体名(例：SMF)を第1引数に入力すること。


# 参考資料

[Micron MT25QL01GBBB Datasheet (PDF)](https://mm.digikey.com/Volume0/opasdata/d220001/medias/docus/1104/MT25QL01GBBB.pdf)   